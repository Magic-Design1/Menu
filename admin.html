<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Admin Fixed | POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #030712; --card: #111827; --primary: #3b82f6; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #f3f4f6; margin: 0; padding: 15px; }

        /* Top Bar Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 20px; text-align: center; border: 1px solid #1f2937; }
        .stat-card small { font-size: 0.6rem; color: #9ca3af; text-transform: uppercase; font-weight: 800; }
        .stat-card div { font-size: 1.2rem; font-weight: 900; margin-top: 5px; }

        /* Containers */
        .layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1024px) { .layout { grid-template-columns: 1fr 350px; } }

        /* Items */
        .order-box { background: var(--card); border-radius: 25px; padding: 20px; border: 1px solid #1f2937; margin-bottom: 15px; }
        .waiter-box { background: #450a0a; border: 2px solid var(--danger); padding: 15px; border-radius: 20px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .btn { width: 100%; padding: 18px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; margin-top: 15px; font-size: 1rem; }
        .btn-green { background: var(--success); color: white; }
        .btn-white { background: white; color: #450a0a; padding: 10px 15px; border-radius: 10px; width: auto; margin-top: 0; }
        
        .item-line { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1f2937; }
        .qty-tag { color: var(--primary); font-weight: 900; margin-right: 8px; }
    </style>
</head>
<body>

<div class="stats-grid">
    <div class="stat-card"><small>Revenue</small><div id="stat-rev" style="color:var(--success)">$0</div></div>
    <div class="stat-card"><small>All Orders</small><div id="stat-count" style="color:var(--primary)">0</div></div>
    <div class="stat-card"><small>Active Calls</small><div id="stat-waiter" style="color:var(--danger)">0</div></div>
</div>

<div class="layout">
    <div id="orders-list"></div>
    <div id="waiter-list"></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNzEr3RsPtckw-AdD1DmFBPW_yLSvVtN8135lvei6tdynJ9HQBJoHDjPnb2WKQzSoeqA/exec";

    async function fetchData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            console.log("Full Data:", data); // مراجعة البيانات في الكونسول
            
            updateDashboard(data);
        } catch (e) { console.error("Sync Error"); }
    }

    function updateDashboard(data) {
        let rev = 0;
        let oCount = 0;
        let wCount = 0;

        const ordersList = document.getElementById('orders-list');
        const waiterList = document.getElementById('waiter-list');

        let ordersHtml = "";
        let waiterHtml = "";

        data.forEach(item => {
            // حساب الإحصائيات (الأرباح لا تختفي أبداً)
            if (item.type === 'order') {
                oCount++;
                let val = parseFloat(item.total.replace(/[^0-9.-]+/g,"")) || 0;
                rev += val;

                // إظهار الطلب فقط إذا لم يكن Done أو Completed
                if (item.status !== 'Done' && item.status !== 'Completed') {
                    ordersHtml += `
                        <div class="order-box" id="item-${item.id}">
                            <div style="display:flex; justify-content:space-between; font-weight:900;">
                                <span>Table ${item.table}</span>
                                <span style="color:var(--success)">${item.total}</span>
                            </div>
                            <div style="margin:15px 0;">
                                ${item.items.map(i => `<div class="item-line"><span><span class="qty-tag">${i.qty}x</span>${i.name}</span></div>`).join('')}
                            </div>
                            <button class="btn btn-green" onclick="handleAction('${item.id}', 'Done')">COMPLETE ORDER</button>
                        </div>`;
                }
            } else if (item.type === 'waiter') {
                // إظهار نداء الويتر فقط إذا لم يكن Resolved
                if (item.status !== 'Resolved') {
                    wCount++;
                    waiterHtml += `
                        <div class="waiter-box" id="item-${item.id}">
                            <b>Table ${item.table}</b>
                            <button class="btn btn-white" onclick="handleAction('${item.id}', 'Resolved')">OK</button>
                        </div>`;
                }
            }
        });

        document.getElementById('stat-rev').innerText = "$" + rev.toFixed(2);
        document.getElementById('stat-count').innerText = oCount;
        document.getElementById('stat-waiter').innerText = wCount;

        ordersList.innerHTML = ordersHtml || '<p style="text-align:center; opacity:0.3;">No active orders</p>';
        waiterList.innerHTML = waiterHtml;
    }

    async function handleAction(id, newStatus) {
        const el = document.getElementById('item-' + id);
        if (el) {
            el.style.opacity = "0.3";
            el.style.pointerEvents = "none";
        }

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'update', id: id, status: newStatus })
            });
            
            // الحل الجذري للاختفاء: مسح العنصر تماماً من الصفحة بعد ثانية
            setTimeout(() => {
                if(el) el.remove();
                fetchData(); // تحديث الأرقام
            }, 800);
        } catch (e) {
            alert("Connection Error");
            if(el) el.style.opacity = "1";
        }
    }

    setInterval(fetchData, 5000);
    fetchData();
</script>
</body>
</html>
