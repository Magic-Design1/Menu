<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Master POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --card: #0f172a; --primary: #3b82f6; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding: 15px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-radius: 20px; border: 1px solid #1e293b; margin-bottom: 20px; }
        .live-indicator { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: 800; }
        .dot { width: 10px; height: 10px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); animation: pulse 1.5s infinite; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 350px 1fr; } }

        /* Waiter Section */
        .waiter-card { 
            background: linear-gradient(135deg, #450a0a, #991b1b); border: 2px solid var(--danger);
            padding: 20px; border-radius: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.2);
        }
        .btn-resolve { background: white; color: #991b1b; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 800; cursor: pointer; }

        /* Kitchen Section */
        .order-card { 
            background: var(--card); border-radius: 25px; padding: 25px; border: 1px solid #1e293b;
            margin-bottom: 15px; position: relative; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .order-card.fade-out { transform: scale(0.9) opacity(0); opacity: 0; }
        
        .table-no { background: var(--primary); color: white; padding: 5px 15px; border-radius: 10px; font-weight: 800; font-size: 0.9rem; }
        .item-list { margin: 20px 0; border-top: 1px dashed #334155; padding-top: 15px; }
        .item-row { display: flex; justify-content: space-between; padding: 5px 0; font-weight: 600; font-size: 1.1rem; }

        .btn-done { 
            width: 100%; background: var(--success); color: white; border: none; padding: 20px; 
            border-radius: 18px; font-weight: 800; font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.2);
        }
        .btn-done:active { transform: scale(0.98); background: #16a34a; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 800; font-size: 1.2rem;">ELITE <span style="color:var(--primary)">POS</span></div>
    <div class="live-indicator"><div class="dot"></div> <span id="sync-text">SYSTEM LIVE</span></div>
</header>

<div class="dashboard-grid">
    <div id="waiter-feed"></div>

    <div id="orders-feed"></div>
</div>

<audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    // Ø­Ø· Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù€ Deployment Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNzEr3RsPtckw-AdD1DmFBPW_yLSvVtN8135lvei6tdynJ9HQBJoHDjPnb2WKQzSoeqA/exec";
    let lastId = 0;

    async function sync() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            
            // ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ Ù„Ù„Ø¬Ø¯ÙŠØ¯
            if(data.length > 0 && data[data.length-1].id !== lastId) {
                if(lastId !== 0) document.getElementById('alertSound').play().catch(e => {});
                lastId = data[data.length-1].id;
            }

            render(data);
            document.getElementById('sync-text').innerText = "SYSTEM LIVE";
        } catch (e) {
            document.getElementById('sync-text').innerText = "CONNECTING...";
        }
    }

    function render(data) {
        const waiterArea = document.getElementById('waiter-feed');
        const ordersArea = document.getElementById('orders-feed');

        const waiters = data.filter(d => d.type === 'waiter');
        const orders = data.filter(d => d.type === 'order');

        waiterArea.innerHTML = waiters.map(c => `
            <div class="waiter-card" id="card-${c.id}">
                <div><b>ğŸ›ï¸ Table ${c.table}</b></div>
                <button class="btn-resolve" onclick="processTask('${c.id}', 'Resolved')">RESOLVE</button>
            </div>
        `).join('');

        ordersArea.innerHTML = orders.reverse().map(o => `
            <div class="order-card" id="card-${o.id}">
                <div style="display:flex; justify-content:space-between">
                    <span class="table-no">TABLE ${o.table}</span>
                    <span style="font-weight:800; color:var(--primary)">${o.total}</span>
                </div>
                <div class="item-list">
                    ${o.items.map(i => `<div class="item-row"><span>${i.qty}x ${i.name}</span></div>`).join('')}
                </div>
                <button class="btn-done" onclick="processTask('${o.id}', 'Done')">COMPLETE ORDER âœ…</button>
            </div>
        `).join('') || '<div style="text-align:center; opacity:0.3; padding:50px;">No Active Orders</div>';
    }

    async function processTask(id, status) {
        // 1. Ø¥Ø®ÙØ§Ø¡ ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù„Ø§ Ù†Ù†ØªØ¸Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±)
        const el = document.getElementById('card-' + id);
        if(el) { el.style.opacity = "0.2"; el.style.pointerEvents = "none"; }

        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ±ÙØ±
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'update', id: id, status: status })
            });
            // 3. Ù…Ø³Ø­Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¨ØµØ±ÙŠØ§Ù‹)
            if(el) el.remove();
        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            if(el) { el.style.opacity = "1"; el.style.pointerEvents = "auto"; }
        }
    }

    setInterval(sync, 4000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 4 Ø«ÙˆØ§Ù†Ù
    sync();
</script>
</body>
</html>

