<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Admin | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --card: #0f172a; --primary: #3b82f6; --success: #22c55e; --danger: #ef4444; }
        * { box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding: 15px; direction: rtl; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-radius: 20px; border: 1px solid #1e293b; margin-bottom: 20px; direction: ltr; }
        
        /* Stats Styles */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #1e293b; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .stat-box small { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .stat-box span { font-size: 1.8rem; font-weight: 900; color: var(--success); }

        .dashboard { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1024px) { .dashboard { grid-template-columns: 1fr 350px; } }

        /* Order Cards */
        .card { background: var(--card); border-radius: 25px; padding: 25px; border: 1px solid #1e293b; margin-bottom: 15px; position: relative; animation: slideUp 0.4s ease; }
        .waiter-card { border: 2px solid var(--danger); background: linear-gradient(to bottom, #450a0a, #1e293b); }
        
        .btn { width: 100%; padding: 18px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; margin-top: 15px; font-size: 1.1rem; transition: 0.2s; }
        .btn-done { background: var(--success); color: white; box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3); }
        .btn-resolve { background: white; color: #991b1b; }
        .btn:active { transform: scale(0.96); opacity: 0.8; }
        
        .item-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #1e293b; font-size: 1.1rem; }
        .table-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 10px; font-size: 0.9rem; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 800; letter-spacing: 1px;">ELITE <span style="color:var(--primary)">POS</span></div>
    <div id="status" style="font-size: 0.7rem; color: var(--success);">â— Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…</div>
</header>

<div class="stats-grid">
    <div class="stat-box">
        <small>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</small>
        <span id="revenue-display">0.00</span>
    </div>
    <div class="stat-box">
        <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</small>
        <span id="orders-count" style="color: var(--primary);">0</span>
    </div>
</div>

<div class="dashboard">
    <div id="orders-feed"></div>

    <div id="waiter-feed"></div>
</div>

<audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ø¯Ù…Ø¬ Ù‡Ù†Ø§
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNzEr3RsPtckw-AdD1DmFBPW_yLSvVtN8135lvei6tdynJ9HQBJoHDjPnb2WKQzSoeqA/exec";

    async function updateSystem() {
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            
            if (!data || !Array.isArray(data)) return;

            // 1. Ù…Ø­Ø±Ùƒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (ÙŠØ­Ø³Ø¨ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù†ÙˆØ¹ order)
            let totalRevenue = 0;
            let totalOrders = 0;

            data.forEach(item => {
                if (item.type === 'order') {
                    totalOrders++;
                    let price = 0;
                    if (typeof item.total === 'string') {
                        price = parseFloat(item.total.replace(/[^0-9.-]+/g, "")) || 0;
                    } else {
                        price = parseFloat(item.total) || 0;
                    }
                    totalRevenue += price;
                }
            });

            document.getElementById('revenue-display').innerText = totalRevenue.toLocaleString('ar-EG', { minimumFractionDigits: 2 });
            document.getElementById('orders-count').innerText = totalOrders;

            // 2. Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
            renderData(data);
            
            document.getElementById('status').innerText = "â— ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±: " + new Date().toLocaleTimeString('ar-EG');
        } catch (e) {
            document.getElementById('status').innerText = "â—‹ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
            document.getElementById('status').style.color = "var(--danger)";
        }
    }

    function renderData(data) {
        const waiterFeed = document.getElementById('waiter-feed');
        const ordersFeed = document.getElementById('orders-feed');

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø´Ø·Ø© (Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§)
        const pendingOrders = data.filter(d => d.type === 'order' && d.status !== 'Done' && d.status !== 'Completed');
        const pendingCalls = data.filter(d => d.type === 'waiter' && d.status !== 'Resolved');

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„ÙˆÙŠØªØ±
        waiterFeed.innerHTML = pendingCalls.map(c => `
            <div class="card waiter-card" id="row-${c.id}">
                <div style="font-weight:800; font-size:1.2rem; margin-bottom:10px;">ğŸ›ï¸ Ù†Ø¯Ø§Ø¡ Ø·Ø§ÙˆÙ„Ø© ${c.table}</div>
                <button class="btn btn-resolve" onclick="finishTask('${c.id}', 'Resolved')">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
            </div>
        `).join('');

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        ordersFeed.innerHTML = pendingOrders.reverse().map(o => `
            <div class="card" id="row-${o.id}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span class="table-badge">Ø·Ø§ÙˆÙ„Ø© ${o.table}</span>
                    <span style="font-weight:900; color:var(--success); font-size:1.3rem;">${o.total}</span>
                </div>
                <div style="margin:10px 0;">
                    ${o.items.map(i => `
                        <div class="item-row">
                            <span>${i.name}</span>
                            <span style="color:var(--primary)">x${i.qty}</span>
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-done" onclick="finishTask('${o.id}', 'Done')">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
            </div>
        `).join('') || '<div style="text-align:center; opacity:0.3; padding:50px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    }

    async function finishTask(id, status) {
        const el = document.getElementById('row-' + id);
        if (el) {
            el.style.transition = "0.3s";
            el.style.opacity = "0.2";
            el.style.transform = "scale(0.95)";
        }

        try {
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø´ÙŠØª
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'update', id: id, status: status })
            });
            // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
            setTimeout(updateSystem, 1000);
        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
            if (el) el.style.opacity = "1";
        }
    }

    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
    setInterval(updateSystem, 5000);
    updateSystem();
</script>
</body>
</html>
